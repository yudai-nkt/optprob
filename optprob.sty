%
% This is a LaTeX package file "optprob.sty."
% (c) 2016 Yudai NAKATA
%
% This package is distributed under the MIT License.
% See LICENSE.md or https://opensource.org/licenses/MIT for details.
%
\NeedsTeXFormat{LaTeX2e}
\def\oppr@pkgname{optprob}
\def\oppr@pkgversion{v0.1.1}
\ProvidesPackage{\oppr@pkgname}[2016/05/20 \oppr@pkgversion\space LeTeX package for the description of optimization problem]
\RequirePackage{pgfopts}
\RequirePackage{mathtools}
\def\oppr@error{\PackageError\oppr@pkgname}
\def\oppr@warning{\PackageWarning\oppr@pkgname}
%
\def\oppr@empty{}
\def\oppr@subscr#1{%
    \if\relax\detokenize\expandafter{#1}\relax
        \expandafter\@gobble
    \else
        \expandafter\@firstofone
    \fi
    {_{#1}}%
}
\DeclareMathOperator*\oppr@operation@op{\oppr@operation}
\def\oppr@operation@ord#1{\mathord{\oppr@operation@op\oppr@subscr{#1}}}
\DeclareMathOperator*\argmax{arg\,max}
\DeclareMathOperator*\argmin{arg\,min}
\def\oppr@subjectto{\mathrm{\oppr@subjectto@notation}}
\newif\ifoppr@abbreviation
\newif\ifoppr@showequationnumber
\def\oppr@switch@notation{%
    \ifoppr@abbreviation
        \def\oppr@maximize@notation{max.}
        \def\oppr@minimize@notation{min.}
        \def\oppr@subjectto@notation{s.t.}
    \else
        \def\oppr@maximize@notation{maximize}
        \def\oppr@minimize@notation{minimize}
        \def\oppr@subjectto@notation{subject~to}
    \fi
}
\pgfkeys{
    /optprob/env/optimize/.cd,
    default/.style={
        abbrev=false,
        showeqnum=true,
        space=1em
    },
    abbrev/.is if=oppr@abbreviation,
    operation/.code={
        \def\oppr@operation{\csname oppr@#1imize@notation\endcsname}
    },
    showeqnum/.is if=oppr@showequationnumber,
    space/.store in=\oppr@space
}
%
\newenvironment{optimize}[2][]{%
    \pgfkeys{/optprob/env/optimize/.cd, default, #1, operation=#2}%
    \oppr@switch@notation
    \newcommand\objfunc[2][]{%
        \newcommand\oppr@variable{##1}%
        \newcommand\oppr@objfunc{##2}%
    }
    \def\addconstraint##1{%
        \if\relax\detokenize\expandafter{\the\@temptokena}\relax
            \@temptokena={\\ & \oppr@subjectto & & ##1}%
        \else
            \@temptokena=\expandafter{\the\@temptokena \\ & & & ##1}%
        \fi
    }%
}{%
    \ifoppr@showequationnumber
        \begin{alignat}{3}
            & \oppr@operation@ord\oppr@variable & \hskip\oppr@space\relax & \oppr@objfunc \the\@temptokena
        \end{alignat}%
    \else
        \begin{alignat*}{3}
            & \oppr@operation@ord\oppr@variable & \hskip\oppr@space\relax & \oppr@objfunc \the\@temptokena
        \end{alignat*}%
    \fi
}
\AtBeginDocument{%
    \ifx\maximize\@undefined
        \newenvironment{maximize}[1][]{%
            \begin{optimize}[#1]{max}
        }{%
            \end{optimize}%
        }
    \fi
    \ifx\minimize\@undefined
        \newenvironment{minimize}[1][]{%
            \begin{optimize}[#1]{min}
        }{%
            \end{optimize}%
        }
    \fi
}
